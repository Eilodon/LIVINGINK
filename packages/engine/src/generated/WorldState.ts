/**
 * AUTO-GENERATED by EIDOLON-V GENESIS - DO NOT EDIT MANUALLY
 * Generated: 2026-02-06T01:42:05.413Z
 * Source: packages/engine/scripts/schema.config.js
 */

export const MAX_ENTITIES = 10000;

export interface IWorldBuffers {
    stateFlags?: ArrayBufferLike;
    transform?: ArrayBufferLike;
    physics?: ArrayBufferLike;
    pigment?: ArrayBufferLike;
    stats?: ArrayBufferLike;
    input?: ArrayBufferLike;
    skill?: ArrayBufferLike;
    config?: ArrayBufferLike;
    projectile?: ArrayBufferLike;
    tattoo?: ArrayBufferLike;
}

export interface IWorldConfig {
    maxEntities?: number;
    buffers?: IWorldBuffers;
}

export class WorldState {
    public readonly maxEntities: number;

    // Entity State Flags (ACTIVE, DEAD, etc.)
    public readonly stateFlags: Uint8Array;

    // Component Buffers
    public readonly transform: Float32Array;
    public readonly transformBuffer: ArrayBufferLike;
    public readonly transformView: DataView;
    public readonly physics: Float32Array;
    public readonly physicsBuffer: ArrayBufferLike;
    public readonly physicsView: DataView;
    public readonly pigment: Float32Array;
    public readonly pigmentBuffer: ArrayBufferLike;
    public readonly pigmentView: DataView;
    public readonly stats: Float32Array;
    public readonly statsBuffer: ArrayBufferLike;
    public readonly statsView: DataView;
    public readonly input: Float32Array;
    public readonly inputBuffer: ArrayBufferLike;
    public readonly inputView: DataView;
    public readonly skill: Float32Array;
    public readonly skillBuffer: ArrayBufferLike;
    public readonly skillView: DataView;
    public readonly config: Float32Array;
    public readonly configBuffer: ArrayBufferLike;
    public readonly configView: DataView;
    public readonly projectile: Float32Array;
    public readonly projectileBuffer: ArrayBufferLike;
    public readonly projectileView: DataView;
    public readonly tattoo: Float32Array;
    public readonly tattooBuffer: ArrayBufferLike;
    public readonly tattooView: DataView;

    // EIDOLON-V: Sparse Set for O(1) Iteration
    public readonly activeEntities: Uint16Array; // Dense [id1, id2, ...]
    public readonly entityToIndex: Int16Array;   // Sparse [id] -> index
    public activeCount: number = 0;

    constructor(config?: IWorldConfig) {
        this.maxEntities = config?.maxEntities ?? MAX_ENTITIES;

        // Allocate State Flags (1 byte per entity)
        if (config?.buffers?.stateFlags) {
            this.stateFlags = new Uint8Array(config.buffers.stateFlags);
        } else {
            this.stateFlags = new Uint8Array(this.maxEntities);
        }

        // Allocate Component Buffers
        if (config?.buffers?.transform) {
            this.transformBuffer = config.buffers.transform;
        } else {
            this.transformBuffer = new ArrayBuffer(this.maxEntities * 32);
        }
        this.transform = new Float32Array(this.transformBuffer);
        this.transformView = new DataView(this.transformBuffer);
        if (config?.buffers?.physics) {
            this.physicsBuffer = config.buffers.physics;
        } else {
            this.physicsBuffer = new ArrayBuffer(this.maxEntities * 32);
        }
        this.physics = new Float32Array(this.physicsBuffer);
        this.physicsView = new DataView(this.physicsBuffer);
        if (config?.buffers?.pigment) {
            this.pigmentBuffer = config.buffers.pigment;
        } else {
            this.pigmentBuffer = new ArrayBuffer(this.maxEntities * 32);
        }
        this.pigment = new Float32Array(this.pigmentBuffer);
        this.pigmentView = new DataView(this.pigmentBuffer);
        if (config?.buffers?.stats) {
            this.statsBuffer = config.buffers.stats;
        } else {
            this.statsBuffer = new ArrayBuffer(this.maxEntities * 32);
        }
        this.stats = new Float32Array(this.statsBuffer);
        this.statsView = new DataView(this.statsBuffer);
        if (config?.buffers?.input) {
            this.inputBuffer = config.buffers.input;
        } else {
            this.inputBuffer = new ArrayBuffer(this.maxEntities * 16);
        }
        this.input = new Float32Array(this.inputBuffer);
        this.inputView = new DataView(this.inputBuffer);
        if (config?.buffers?.skill) {
            this.skillBuffer = config.buffers.skill;
        } else {
            this.skillBuffer = new ArrayBuffer(this.maxEntities * 16);
        }
        this.skill = new Float32Array(this.skillBuffer);
        this.skillView = new DataView(this.skillBuffer);
        if (config?.buffers?.config) {
            this.configBuffer = config.buffers.config;
        } else {
            this.configBuffer = new ArrayBuffer(this.maxEntities * 32);
        }
        this.config = new Float32Array(this.configBuffer);
        this.configView = new DataView(this.configBuffer);
        if (config?.buffers?.projectile) {
            this.projectileBuffer = config.buffers.projectile;
        } else {
            this.projectileBuffer = new ArrayBuffer(this.maxEntities * 16);
        }
        this.projectile = new Float32Array(this.projectileBuffer);
        this.projectileView = new DataView(this.projectileBuffer);
        if (config?.buffers?.tattoo) {
            this.tattooBuffer = config.buffers.tattoo;
        } else {
            this.tattooBuffer = new ArrayBuffer(this.maxEntities * 16);
        }
        this.tattoo = new Float32Array(this.tattooBuffer);
        this.tattooView = new DataView(this.tattooBuffer);

        // EIDOLON-V: Initialize Sparse Set
        this.activeEntities = new Uint16Array(this.maxEntities);
        this.entityToIndex = new Int16Array(this.maxEntities).fill(-1);
    }

    /**
     * Reset all component data to zero
     */
    reset(): void {
        this.stateFlags.fill(0);
        this.transform.fill(0);
        this.physics.fill(0);
        this.pigment.fill(0);
        this.stats.fill(0);
        this.input.fill(0);
        this.skill.fill(0);
        this.config.fill(0);
        this.projectile.fill(0);
        this.tattoo.fill(0);

        // EIDOLON-V: Reset Sparse Set
        this.activeCount = 0;
        this.activeEntities.fill(0);
        this.entityToIndex.fill(-1);
    }

    /**
     * Check if entity ID is valid
     */
    isValidEntityId(id: number): boolean {
        return id >= 0 && id < this.maxEntities;
    }
}

// STRIDES in floats (for array indexing, not bytes)
export const STRIDES = {
    TRANSFORM: 8,
    PHYSICS: 8,
    PIGMENT: 8,
    STATS: 8,
    INPUT: 4,
    SKILL: 4,
    CONFIG: 8,
    PROJECTILE: 4,
    TATTOO: 4,
} as const;

/**
 * Default global WorldState instance.
 * Used for backward compatibility with static Store classes.
 * @deprecated Prefer injecting WorldState instances for new code.
 */
export const defaultWorld = new WorldState();

// EIDOLON-V P6: Runtime deprecation warning
declare const __DEV__: boolean | undefined;
if (typeof console !== 'undefined' && typeof __DEV__ !== 'undefined' && __DEV__) {
    console.warn('[EIDOLON-V] defaultWorld singleton is deprecated. Use new WorldState() for instance-based architecture.');
}
