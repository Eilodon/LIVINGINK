 **COLOR JELLY RUSH – Full Power** 
---

# A. Bản đồ repo hiện tại: cái gì giữ, cái gì thay

## 1) Những “xương sống” nên giữ gần như nguyên

**Engine & perf**

* `services/engine/context.ts` → `SpatialGrid`, pooling, bindEngine (giảm GC, rất hợp .io)
* `services/engine/systems/physics.ts` → `applyPhysics`, `applyGrowth`, `updateTier` (chống snowball đã có sẵn)

**AI**

* `services/engine/systems/ai.ts` → scan nearby qua SpatialGrid, logic chase/flee/wander (đổi tiêu chí mục tiêu)

**Roguelite UI**

* `components/MutationPicker.tsx` + `services/mutations.ts` → đổi tên thành **Tattoo**

**Networking**

* `server/src/rooms/GameRoom.ts` + `server/src/schema/GameState.ts` (Colyseus authoritative)
* `services/networking/NetworkClient.ts` (client sync + interpolation)

**Mobile**

* `components/MobileControls.tsx` (joystick + nút skill/eject)

**VFX/Audio**

* `services/vfx/VFXManager.ts`, `services/audio/AudioEngine.ts`, `services/engine/effects.ts`, `services/haptics.ts`

---

## 2) Những thứ nên “đóng lại / bỏ / để sau”

* `Faction`, `Bloodline`, `Elemental counters`, hazard lightning/geyser/icicle… → bỏ khỏi loop chính
* `zoneRadius shrink` → thay bằng **Ring Membrane**
* `relic/landmarks` → bỏ (trừ khi fen muốn làm “event” sau)

---

# B. Kiến trúc mục tiêu (để code sạch và scale)

## 1) Nguyên tắc: “Core Rules” phải nằm riêng

Tạo module mới để tránh trộn với bản cũ:

```
services/cjr/
  cjrTypes.ts
  cjrConstants.ts
  colorMath.ts
  ringSystem.ts
  waveSpawner.ts
  bossCjr.ts
  contribution.ts
  emotions.ts
  tattoos.ts
  balance.ts
```

Và trong engine loop, ta gọi hệ CJR theo thứ tự:

**Tick order chuẩn**

1. Input → movement intent
2. Physics
3. Ring gate (commit 1 chiều)
4. Wave spawn tick
5. Consume pickups (pigment/neutral/solvent/...) → cập nhật pigment + match
6. Combat / boss damage
7. Contribution tier reward & boss events
8. Dynamic bounty (Candy Vein)
9. Win condition (hold center + heartbeat pulse)
10. Emotion update
11. VFX/audio triggers

---

# C. Roadmap triển khai theo PR (đúng kiểu team dev làm là chạy)

## PR0 — Setup & “đừng phá main”

* Tạo branch: `color-jelly-rush`
* Thêm script tiện:

  * root: `npm run dev`
  * server: `npm run dev` trong `/server`
* Quy ước: **server là source of truth** cho mass/match/ring khi bật multiplayer.

---

## PR1 — Data Model mới cho COLOR JELLY RUSH (compile pass)

### 1) Tạo types riêng (khuyến nghị)

**File mới:** `services/cjr/cjrTypes.ts`

**Những type bắt buộc**

* `PigmentVec3 = { r:number; g:number; b:number }` (0..1)
* `RingId = 1 | 2 | 3`
* `Emotion = 'happy'|'hungry'|'yum'|'greed'|'focus'|'panic'|'despair'|'victory'|'ko'`
* `PickupKind = 'pigment'|'neutral'|'solvent'|'catalyst'|'shield'|'candy_vein'`
* `ShapeId = 'circle'|'square'|'triangle'|'hex'` (MVP 4 shape)

### 2) Patch vào `types.ts` hiện tại theo hướng ít đập nhất

Để giảm sửa lan:

* Giữ `Player extends Entity` nhưng thêm field:

  * `pigment: PigmentVec3`
  * `targetPigment: PigmentVec3`
  * `matchPercent: number` (0..1)
  * `ring: RingId`
  * `emotion: Emotion`
  * `shape: ShapeId`
  * `tattoos: TattooId[]` (rename MutationId → TattooId)
* `Food` đổi thành “pickup” bằng cách thêm:

  * `kind: PickupKind`
  * `pigment?: PigmentVec3` (chỉ có nếu kind = pigment/candy_vein)

> Mục tiêu PR1: **build chạy** dù gameplay chưa đổi hết.

---

## PR2 — Constants & Balance (ring + thresholds + wave)

**File mới:** `services/cjr/cjrConstants.ts`

Chốt mặc định (đúng thứ fen đã chốt + trích dẫn):

* Ring radii: `R1` (outer), `R2`, `R3`, `CENTER`
* Threshold:

  * into Ring2: `0.50`
  * into Ring3: `0.70`
  * win hold: `0.90`
* Commit buff khi vào ring mới:

  * shield `2.0s`
  * speed `+10%` `2.0s`
* Wave interval:

  * ring1: 8s
  * ring2: 10s
  * ring3: 12–14s
* Spawn ratio per wave:

  * pigment 60%
  * neutral 25%
  * special 15%

**Candy Vein dynamic bounty (chốt theo trích dẫn)**

* Trigger: nếu số người sống trong Ring3 ≤ 30% tổng người sống
* Spawn: 8–10s tồn tại, gần tâm
* Effect: boost match + mass “đủ lật kèo”

---

## PR3 — Color Math: mix + match% + hint (linh hồn game)

**File mới:** `services/cjr/colorMath.ts`

### 1) Mix pigment khi ăn

* Nếu pickup `pigment`:

  * `player.pigment = lerp(player.pigment, pickup.pigment, alpha)`
  * `alpha` phụ thuộc “khối lượng hạt” vs “khối lượng player” (player càng to → alpha nhỏ)
* Nếu pickup `neutral`: tăng mass, **không đổi pigment**
* Nếu `solvent`: kéo pigment về trung tính nhẹ
* Nếu `catalyst`: buff tạm thời làm alpha mạnh hơn vài giây

### 2) Match% (casual-friendly, không RGB lộ)

Tính similarity bằng:

* Cosine similarity hoặc 1 - normalized L2
  Output: `0..1` → HUD hiển thị %.

### 3) Snap assist & pity boost

* Nếu `match >= 0.80`: ăn đúng pigment tăng alpha thêm chút
* Nếu bị kẹt dưới ngưỡng lâu: bật buff 4s

---

## PR4 — Ring System: màng màu + commit 1 chiều (không cổng)

**File mới:** `services/cjr/ringSystem.ts`

### Logic ring

* Xác định ring theo vị trí (distance to center)
* Nếu player đang ở Ring1 và vị trí “đã vượt ranh” Ring2:

  * nếu `match >= 0.50` → `ring = 2` (commit)
  * else → bật “bounce VFX” (nhưng vì fen đã đổi sang commit 1 chiều, phần bounce chủ yếu là feedback)
* Tương tự Ring2 → Ring3 với `0.70`
* Vào rồi **không ra**: ring chỉ tăng, không giảm.

### Boss gate theo ring

* Ring2 chỉ “active” khi Boss1 alive/defeated rule của fen:

  * Có 2 cách:

    1. Boss là “event” không khóa ring (casual hơn)
    2. Boss chết mới cho vào ring tiếp theo (drama hơn)
* Fen chốt kiểu nào thì code theo đó; bản full-power hay nhất là:

  * **Boss1 chết → mở “rush window” 5s để tiến Ring3 dễ hơn**

---

## PR5 — Wave Spawner: tài nguyên theo nhịp (chống ăn sạch map)

**File mới:** `services/cjr/waveSpawner.ts`

### Tại sao phải đặt ở server / engine core?

* Nếu client spawn → cheat/khác biệt sync.
* Đặt trong engine (singleplayer) và mirror sang server.

### Wave tick

* Mỗi ring có `waveTimer`
* Khi timer <= 0:

  * spawn pickups theo budget * (số người sống trong ring)
  * reset timer theo interval ring

### Spawn anti-hoard

* Rải đều theo góc (stratified sampling)
* Không spawn dồn vào 1 vùng
* Optional: spawn xa “top mass” một chút (rubber-band kín)

---

## PR6 — Boss CJR + Contribution Tier (giải toxic last hit)

Repo đang có `services/bossSystem.ts` rất nặng (Souls-like). Full power CJR nên **đơn giản hóa**:

**File mới:** `services/cjr/bossCjr.ts`

* Boss1 (Ring2): pattern dễ đọc (telegraph)
* Boss2 (Ring3): pattern nhanh hơn, ít skill hơn nhưng drama

**Contribution Tier (chốt theo trích dẫn)**
**File mới:** `services/cjr/contribution.ts`

* Track: `bossDamageByPlayer[sessionId] += dmg`
* Khi boss chết:

  * Top1: speed +20% 4s + shield 2s
  * Top2–3: speed +15% 3s
  * Top4–8: speed +10% 2s
* “Last hit” vẫn có VFX/sfx spotlight, nhưng **reward dựa tier**.

---

## PR7 — Dynamic Bounty: Candy Vein (Ring3 cứu death zone)

**File mới:** `services/cjr/dynamicBounty.ts` (hoặc gộp `waveSpawner`)

* Condition check mỗi tick:

  * `aliveRing3 / aliveTotal <= 0.30` và chưa spawn vein gần đây
* Spawn 1 entity kind `candy_vein`:

  * radius lớn hơn pigment thường
  * tồn tại 8–10s
  * consume → boost match mạnh + mass vừa đủ

---

## PR8 — Win Hold + Heartbeat Pulse (cực “đã”)

**File mới:** `services/cjr/winCondition.ts`

* Nếu player vào vùng tâm và match >= 0.90:

  * start channel timer 1.5s
  * mỗi 0.5s → emit “pulse event” (vfx + sound + shake)
  * càng gần finish pulse càng dồn
* Bị hit → reset channel một phần (để lật kèo nhưng không quá cay)

---

## PR9 — Emotion System (chibi jelly sống)

**File mới:** `services/cjr/emotions.ts`

Trigger gọn:

* Happy default
* Hungry: lâu không ăn / mass nhỏ
* Yum: ăn combo
* Greed: thấy special wave / candy vein gần
* Focus: gần ngưỡng ring / gần win
* Panic: có enemy lớn áp sát
* Despair: ở ring3 mà match tụt dưới 70% quá X giây
* Victory: đang hold gần xong
* KO: chết

Renderer chỉ cần đọc `player.emotion` để đổi mặt + icon.

---

# D. Client Rendering & UI (từ prototype tới “full power Pixi”)

## PR10 — HUD mới: Match vòng quanh jelly + notch 50/70/90

Sửa `components/HUD.tsx`:

* Hiển thị:

  * Match% dạng vòng (circular progress)
  * Notch 50/70/90
  * Hint 1 dòng: “Thiếu ĐỎ”, “Dư XANH”, “Cần nhạt hơn”
  * Ring current + timer wave
* Mini map: chỉ ring boundaries + boss + center (không show player)

## PR11 — Render rings + membrane living

### Canvas2D nhanh (MVP)

`components/GameCanvas.tsx`

* Vẽ 3 vòng + màng (alpha pulse)
* Player: blob + highlight
* Pickup: chấm màu + sparkle

### PixiJS full power (đẹp)

`components/PixiGameCanvas.tsx`

* Particle pool reuse
* Jelly shader “giả” bằng sprite overlay + wobble (đừng thật physics nặng)
* Membrane effect: noise texture + alpha oscillation
* Commit effect: “rip open” + sound “shlorp”

---

# E. Multiplayer Full Power (Colyseus authoritative)

## PR12 — Server schema: thêm pigment/ring/match/emotion/pickups kinds

Sửa:

* `server/src/schema/GameState.ts`
* `server/src/rooms/GameRoom.ts`

Nguyên tắc:

* Client **chỉ gửi input**: direction/skill/eject
* Server compute:

  * physics
  * consume pickups
  * pigment/match
  * ring commit
  * boss damage + contribution tier
  * win hold timer

## PR13 — Client networking wiring

`services/networking/NetworkClient.ts` đã có khung tốt.

* Map server state → local render state
* Interpolation:

  * position, radius, pigment (lerp nhẹ)
  * emotion state sync

**Anti-cheat tối thiểu**

* Server validate:

  * speed cap theo radius
  * matchPercent derived từ pigment, không nhận từ client
  * input rate-limit skill

---

# F. Content layer (giữ “casual sạch” nhưng đủ nghiện)

## PR14 — Shapes 4 cái (MVP)

* Circle (Runner): dash
* Square (Tank): bump
* Triangle (Assassin): pierce
* Hex (Magnet): mini-magnet 2s

## PR15 — Tattoos (12 cái) = đổi từ mutations

* Rename `services/mutations.ts` → `services/cjr/tattoos.ts`
* UI rename `MutationPicker.tsx` → `TattooPicker.tsx`
* Mỗi level/size threshold → show chọn 1/3

(“Tattoo Fusion” để V1.2 sau, tránh vỡ balance.)

---

# G. QA + Tuning + Telemetry (để không chết vì balance)

## Test tối thiểu cần có (repo đã có `tests/`)

Thêm test cho:

* `matchPercent` monotonic: ăn đúng màu phải tăng
* ring commit: vào ring2/ring3 đúng threshold
* wave spawn budget: không spawn vượt cap
* contribution tier: đúng top list
* win hold: pulse timing chuẩn

## Telemetry hooks (ít nhưng đủ)

* time-to-ring2, time-to-ring3, win-rate by ring entry time
* distribution match at death
* pickup consumption rates
* boss participation % (bao nhiêu người góp dmg)

---

# H. Checklist “DONE = Full Power”

Khi nào fen gọi là “full power” thì cần tick đủ:

* [ ] 3 ring + commit 1 chiều
* [ ] threshold 50/70/90 + HUD notch
* [ ] wave spawn theo ring
* [ ] boss + contribution tier reward
* [ ] Candy Vein dynamic bounty
* [ ] win hold 1.5s + heartbeat pulse
* [ ] emotion system + jelly juice + membrane living
* [ ] PixiJS renderer mượt mobile
* [ ] Colyseus server authoritative + client interpolation
* [ ] bots personality tối thiểu (farmer/hunter/bully/greedy)

---

# I. Gợi ý “thứ tự làm để ra playable nhanh nhất”

Nếu fen muốn “chơi được ngay” rồi mới polish:

1. PR1–PR5 (types + color + ring + wave) → playable local
2. PR8 (win hold + pulse) → game có ending đã
3. PR6–PR7 (boss + tier + candy vein) → drama
4. PR10–PR11 (HUD + Pixi) → đẹp
5. PR12–PR13 (multiplayer) → .io thật

---
